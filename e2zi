#!/usr/bin/env bash

# ============================================================
#  Name        : e2zi
#  Description : Interactive compression tool using xz & tar
#  Version     : 1.0.0
#  Powered by  : ALI NAMI
# ============================================================

show_help() {
    echo "Usage: e2zi [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -p, --path DIR       target directory (default: current)"
    echo "  -l, --level 1-9      compression level (default: 6)"
    echo "  -t, --tar            create tar archive"
    echo "  -y, --yes            auto-confirm prompts"
    echo "  -h, --help           show this help message"
}

# Default values
folder_path=$(pwd)
compression_level=6
tar_choice="no"
auto_confirm="no"

# ---------- Parse CLI arguments ----------
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -p|--path) folder_path="$2"; shift ;;
        -l|--level) compression_level="$2"; shift ;;
        -t|--tar) tar_choice="yes" ;;
        -y|--yes) auto_confirm="yes" ;;
        -h|--help) show_help; exit 0 ;;
        *) echo "Unknown parameter: $1"; show_help; exit 1 ;;
    esac
    shift
done

# ---------- Colors ----------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ---------- Get folder path (interactive if needed) ----------
if [ "$auto_confirm" != "yes" ]; then
    echo "Please enter your folder path (press ENTER for current folder):"
    read -r user_folder
    if [ -n "$user_folder" ]; then
        folder_path="$user_folder"
    fi
fi

# Check folder exists
if [ ! -d "$folder_path" ]; then
    echo -e "${RED}Error: Folder '$folder_path' does not exist.${NC}"
    exit 1
fi

# ---------- List only files (skip directories) ----------
mapfile -t file_list < <(find "$folder_path" -maxdepth 1 -type f -printf "%f\n")

if [ "${#file_list[@]}" -eq 0 ]; then
    echo -e "${YELLOW}No files found in '$folder_path' to compress.${NC}"
    exit 0
fi

# ---------- Show list (interactive) ----------
if [ "$auto_confirm" != "yes" ]; then
    counter=1
    echo "List of files in '$folder_path':"
    for item in "${file_list[@]}"; do
        echo -e "${RED}$counter.${NC} $item"
        ((counter++))
    done

    echo -e "${GREEN}Great!!!${NC}${YELLOW} Now please enter which file(s) you want to compress (enter numbers separated by ,):${NC}"
    read -r file_numbers
else
    # auto-confirm: compress all files
    file_numbers=$(seq 1 "${#file_list[@]}" | tr '\n' ',' | sed 's/,$//')
fi

# ---------- Compression level ----------
if [ "$auto_confirm" != "yes" ]; then
    echo -e "${YELLOW}Enter compression level (1-9, default $compression_level): ${NC}"
    read -r input_level
    if [[ "$input_level" =~ ^[1-9]$ ]]; then
        compression_level="$input_level"
    fi
fi

# ---------- Parse selected indices ----------
IFS=',' read -ra selected_indices <<< "$file_numbers"

# ---------- Compression ----------
echo -e "${GREEN}Starting compression...${NC}"
compressed_files=()

for index in "${selected_indices[@]}"; do
    index=$(echo "$index" | xargs)
    if [[ "$index" =~ ^[0-9]+$ ]] && [ "$index" -ge 1 ] && [ "$index" -le "${#file_list[@]}" ]; then
        file_to_compress="${file_list[$((index-1))]}"
        full_path="$folder_path/$file_to_compress"
        echo -e "${YELLOW}Compressing: $file_to_compress${NC}"
        xz -zvk -"$compression_level" "$full_path"
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}Successfully compressed $file_to_compress${NC}"
            compressed_files+=("$(basename "$file_to_compress").xz")
        else
            echo -e "${RED}Failed to compress $file_to_compress${NC}"
        fi
    else
        echo -e "${RED}Invalid number: $index${NC}"
    fi
done

# ---------- Tar option ----------
if [ "$auto_confirm" == "yes" ] || [ "$tar_choice" == "yes" ]; then
    cd "$folder_path" || { echo -e "${RED}Cannot enter folder $folder_path${NC}"; exit 1; }
    tar_file="compressed_files.tar"
    echo -e "${YELLOW}Creating tar archive: $tar_file${NC}"
    tar -cvf "$tar_file" "${compressed_files[@]}"
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Successfully created tar archive: $tar_file${NC}"
        if [ "$auto_confirm" != "yes" ]; then
            echo -e "${YELLOW}Do you want to delete the individual .xz files after creating the tar? (y/n)${NC}"
            read -r delete_choice
            delete_choice=$(echo "$delete_choice" | tr '[:upper:]' '[:lower:]')
            if [[ "$delete_choice" == "y" || "$delete_choice" == "yes" ]]; then
                for f in "${compressed_files[@]}"; do
                    rm -f "$f"
                done
                echo -e "${GREEN}All individual .xz files deleted.${NC}"
            fi
        fi
    else
        echo -e "${RED}Failed to create tar archive${NC}"
    fi
fi

echo -e "${GREEN}All done!${NC}"

